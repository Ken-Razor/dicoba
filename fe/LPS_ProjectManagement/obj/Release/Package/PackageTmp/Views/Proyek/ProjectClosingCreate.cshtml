@model LPS_ProjectManagement.Models.TransaksiClosingModels.ClosingProjectDetailModel
@using LPS_ProjectManagement.Models

@{
    ViewBag.Title = "Project Closing";
    Layout = "~/Views/Shared/_Layout.cshtml";
    RoleProject[] RoleAplikasi = (RoleProject[])Session["Roles"];
}

<input id="hdf" type="hidden" value="@Session["PersonalNumber"].ToString()" />

<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
    <div class="content-body">
        <ul class="wizard">
            <li class="completed">Step 1 : Initation & Planning</li>
            <li class="completed">Step 2 : Execution</li>
            <li class="current">Step 3 : Closing</li>
        </ul>
        <br />
        <div class="row padiing-top-15">
            <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12">
                <div class="form-group">
                    <label class="form-label label-header" for="txtClosingDate">Nama Project</label>
                    <span class="desc"></span>
                    <input disabled="disabled" id="txtProjectName" type="text" class="form-control datepicker input-header" value="@Model.ProjectName" />
                </div>
            </div>
        </div>

        <div class="row padiing-top-15">
            <div class="col-lg-6 col-md-6 col-sm-12 col-xs-12">
                <div class="form-group">
                    <label class="form-label label-header" for="txtClosingDate">Tanggal Closing</label>
                    <span class="desc"></span>
                    @if (Model.StatusName == "ACTIVE" || Model.StatusName == "COMPLETED")
                    {
                        if (Model.ClosingDate.ToString("yyyy-MM-dd") == "0001-01-01")
                        {
                            <input id="txtClosingDate" type="date" class="form-control datepicker input-header" value="@DateTime.Now.ToString("yyyy-MM-dd")" />
                        }
                        else
                        {
                            <input id="txtClosingDate" type="date" class="form-control datepicker input-header" value="@Model.ClosingDate.ToString("yyyy-MM-dd")" />
                        }
                    }
                    else
                    {
                        <input disabled="disabled" id="txtClosingDate" type="date" class="form-control datepicker input-header" value="@Model.ClosingDate.ToString("yyyy-MM-dd")" />
                    }
                </div>
            </div>
        </div>

        <div class="row padding-top-0">
            <div class="col-lg-6 col-md-6 col-sm-6 col-xs-12">
                <div class="form-group">
                    <label class="form-label label-header" for="wcbi">What Next</label>
                    <span class="desc"></span>
                    <div id="wcbi"></div>
                </div>
            </div>
        </div>

        <div class="row padding-top-0">
            <div class="col-lg-6 col-md-6 col-sm-6 col-xs-12">
                <div class="form-group">
                    <label class="form-label label-header" for="r">Leason Learn</label>
                    <span class="desc"></span>
                    <div id="r"></div>
                </div>
            </div>
        </div>

        @if (Model.StatusName == "ACTIVE" || Model.StatusName == "COMPLETED")
        {
            if (RoleAplikasi.Any(x => x.Role == "EDIT.CLOSING") || RoleAplikasi.Any(x => x.Role == "SUBMIT.CLOSING"))
            {
                <div class="row padding-top-0">
                    <div class="col-md-3">
                        <input type="file" id="uploadMPP" multiple />
                    </div>
                    <div class="col-md-9">
                        <button class="btn btn-success tooltipcustom" type="button" onclick="Upload()">
                            <i class="fa fa-cloud-upload"></i>
                            <span class="tooltiptext">Upload</span>
                        </button>
                    </div>
                    <div class="col-md-12">
                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                    </div>
                </div>
            }
        }


        <div class="row padding-top-0">

            <div class="col-lg-8 col-md-8 col-sm-12 col-xs-12">
                <div class="form-group has-focus">

                    <span class="desc"></span>
                    <div class="controls">
                        <div class="row">
                            <div class="col-md-3 col-xs-3 col-lg-3">

                            </div>
                            <div class="col-md-4 col-xs-4 col-lg-4">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th width="50%">Name</th>
                                            <th width="10%">Keterangan</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="uploadmpp-tbody">
                                        @if (Model.Document.Count > 0)
                                        {
                                            foreach (var item in Model.Document)
                                            {
                                                <tr id="@item.ID">
                                                    <td>@item.DocName</td>
                                                    <td>@item.DocType</td>
                                                    <td>
                                                        <button type="button" class="btn btn-primary" onclick="location.href='@Url.Action("Download", "Upload",new { ProjectHeaderID = Request["IDProjectHeader"] ,  name = @item.DocName } )';"><i class="fa fa-cloud-download"></i></button>
                                                        @if (Model.StatusName == "ACTIVE" || Model.StatusName == "COMPLETED")
                                                        {
                                                            if (RoleAplikasi.Any(x => x.Role == "EDIT.CLOSING") || RoleAplikasi.Any(x => x.Role == "SUBMIT.CLOSING"))
                                                            {
                                                                <button type="button" class="btn btn-danger" onclick="if(confirm('Are you sure?')) deletefile(@item.ID);"><i class="fa fa-trash"></i></button>
                                                            }
                                                        }



                                                    </td>

                                                </tr>
                                            }
                                        }

                                    </tbody>
                                </table>
                            </div>
                        </div>

                    </div>
                </div>
            </div>

        </div>

        <div class="row padding-top-15">
            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                <button class="btn btn-secondary btn-icon  right15 margin-bottom-15" onclick="location.href='@Url.Action("ProjectClosing", "Proyek")'">
                    <i class="fa fa-link"></i> &nbsp; <span>Back To List</span>
                </button>
                @if (Model.StatusName == "ACTIVE" || Model.StatusName == "COMPLETED")
                {
                    <button class="btn btn-success btn-icon  right15 margin-bottom-15" onclick="InsertProjectClosing()">
                        <i class="fa fa-folder-o"></i> &nbsp; <span>Close Project</span>
                    </button>
                }
                @if (Model.StatusName == "CLOSE") { 
                    <button class="btn btn-success btn-icon  right15 margin-bottom-15" onclick="location.href='@Url.Action("ProjectExecutionReport", "Proyek", new { ProjectHeaderID = Request["IDProjectHeader"], IsTransformasi = Request["IsTransformasi"]})'">
                        <i class="fa fa-link"></i> &nbsp; <span>Detail Realisasi</span>
                    </button>
               }
            </div>
        </div>



    </div>
</div>

<script>

    var obj = @Html.Raw(Json.Encode(Model));

    var urlInsertProjectClosing = '@Url.Action("InsertProjectClosing", "Proyek")';
    var urlProjectClosing = '@Url.Action("ProjectClosing", "Proyek")';

    // -- HTML Editor -- \\
    $('#r').summernote({
        tabsize: 2,
        height: 150,
        toolbar: [
            ['style', ['style']],
            ['font', ['bold', 'italic', 'underline', 'strikethrough', 'superscript', 'subscript', 'clear']],
            ['fontname', ['fontname']],
            ['fontsize', ['fontsize']],
            ['color', ['color']],
            ['para', ['ol', 'ul', 'paragraph', 'height']],
            ['view', ['undo', 'redo']]
        ],
        placeholder: ''
    });
    $('#r').summernote(
        'code',
        obj.Remarks
    );

    $('#wcbi').summernote({
        tabsize: 2,
        height: 150,
        toolbar: [
            ['style', ['style']],
            ['font', ['bold', 'italic', 'underline', 'strikethrough', 'superscript', 'subscript', 'clear']],
            ['fontname', ['fontname']],
            ['fontsize', ['fontsize']],
            ['color', ['color']],
            ['para', ['ol', 'ul', 'paragraph', 'height']],
            ['view', ['undo', 'redo']]
        ],
        placeholder: ''
    });
    $('#wcbi').summernote(
        'code',
        obj.WhatCanBeImproved
    );

    if (obj.StatusName != 'COMPLETED' && obj.StatusName != 'ACTIVE') {
        $('#wcbi').summernote('disable');
        $('#r').summernote('disable');
    }

    function InsertProjectClosing() {
        debugger;

        var r = confirm("Anda yakin ingin closing project ini ?");

        if (r == true) {

            var ClosingProjectDetail = {
                ProjectName : obj.ProjectName,
                IDProjectHeader : obj.IDProjectHeader,
                ClosingDate : $('#txtClosingDate').val(),
                Remarks: $('#r').summernote('code').replace(/</g, "{").replace(/>/g, "}"),
                WhatCanBeImproved: $('#wcbi').summernote('code').replace(/</g, "{").replace(/>/g, "}"),
                CreatedBy: $('#hdf').val()
            };

            $.ajax({
                type: "POST",
                url: urlInsertProjectClosing,
                data: ClosingProjectDetail,
                success: function (result) {
                    if (result.Result === "Success") {
                        debugger;
                        alert(result.Message);
                        window.location.href = urlProjectClosing;
                    }
                    else {
                        debugger;
                        alert(result.Message);
                    }
                }
            });

        }


    }

    function Upload() {
        var $file = document.getElementById('uploadMPP'),
            $formData = new FormData();

        if ($file.files.length > 0) {
            for (var i = 0; i < $file.files.length; i++) {
                $formData.append('file-' + i, $file.files[i]);
            }
        }

        
          $.ajax({
            url: '@Url.Action("UploadFile", "Upload", new { ProjHead = Request["IDProjectHeader"] + "|4|3|0" })',
            type: 'POST',
                 data: $formData,
                 dataType: 'json',
                 contentType: false,
                 processData: false,
              success: function (result) {
                  debugger;
                  if (result == "OK") {
                      var uploadhtml = "";
                      var oFile = document.getElementById("uploadMPP").files[0];

                      uploadhtml += "<tr id='" + result + "'><td>Closing_" + oFile.name + "</td><td>-</td>";
                      uploadhtml += '<td> <button type="button" class="btn btn-danger" onclick="if(confirm("Are you sure ?")) deletefile(' + result + ');"><i class="fa fa-trash"></i></button>';
                      uploadhtml += '</tr>';
                      $("#uploadmpp-tbody").append(uploadhtml);
                  } else {
                      alert("Error Upload Data");
                  }
                }
            });
    }


    function deletefile(ID) {
        var data = '@Url.Action("DeleteFile", "Upload", new { ProjectHeaderID = Request["IDProjectHeader"]})' +'&DocumentID=' + ID;
        $.ajax({
            url: data,
            type: 'POST',
            dataType: 'json',
            success: function (result) {
                if (result.status.includes("S|Success")) {
                    var row = '#uploadmpp-tbody tr#' + ID;
                    $(row).remove();
                }
                else {
                    alert('File Gagal Dihapus')
                }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                alert("Status: " + textStatus); alert("Error: " + errorThrown);
            }       
        });
        }

</script>