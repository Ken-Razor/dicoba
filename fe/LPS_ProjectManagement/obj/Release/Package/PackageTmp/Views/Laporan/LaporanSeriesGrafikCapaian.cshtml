@model LPS_ProjectManagement.Models.DashboardModels.DashboardProject.DashboardProjectHeaderModel

@{
    ViewBag.Title = "Grafik Time Series Pencapaian";
}
@using LPS_ProjectManagement.Helper;

<input id="hdfYear" value="@DateTime.Now.Year.ToString()" hidden="hidden" />

<input id="hdfMonth" value="@DateTime.Now.Month.ToString()" hidden="hidden" />


<div class="row">
    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
        <section class="box">
            <div class="content-body padding-top-15" style=" max-height: 450px;overflow: auto;">
                <div class="row padding-5" style="margin:-15px">

                    <div class="col-md-2 padding-top-30">
                        <h4>Jenis Capaian</h4>
                        <select id="ddlJenisCapaian" class="form-control ddlJenisCapaian" style="width:100%;" onchange="OnOnchangeDdlJenisCapaian()">
                            <option value="Fisik" selected="selected">Capaian Fisik</option>
                            <option value="Kpi">Capaian KPI</option>
                        </select>
                    </div>
                    <div class="col-md-2 padding-top-30">
                        <h4>Year</h4>
                        <select id="ddlYear" class="form-control ddlYear" style="width:100%;" onchange="OnOnchangeDdlYear(@DateTime.Now.Year, @DateTime.Now.Month)">
                            @for (int year = Convert.ToInt32(DateTime.Now.Year.ToString()) - 10; year <= Convert.ToInt32(DateTime.Now.Year.ToString()); year++)
                            {
                                if (Convert.ToInt32(DateTime.Now.Year.ToString()) == year)
                                {
                                    <option value=@year selected="selected">@year</option>
                                }
                                else
                                {
                                    <option value=@year>@year</option>
                                }
                            }
                        </select>
                    </div>

                    <div class="col-md-2 padding-top-30" id="triwulan" hidden="hidden">
                        <h4>Triwulan</h4>
                        <select id="ddlTW" class="form-control ddlTW" style="width:100%">
                            <option value="TW1" selected="selected">TW1</option>
                            <option value="TW2">TW2</option>
                            <option value="TW3">TW3</option>
                            <option value="TW4">TW4</option>
                        </select>
                    </div>

                    <div class="col-md-2 padding-top-30" id="month">
                        <h4>Month</h4>
                        <select id="ddlMonth" class="form-control ddlMonth" style="width:100%" onchange="OnOnchangeDdlMonth()">
                            @{ var ListMonth = GlobalHelper.ListDropDowMonth(); }
                            @for (int i = 0; i < 12; i++)
                            {
                                if (ListMonth[i].Month == DateTime.Now.Month)
                                {
                                    <option value="@ListMonth[i].Month" selected="selected">@ListMonth[i].Description</option>
                                    i = 12;
                                }
                                else
                                {
                                    <option value="@ListMonth[i].Month">@ListMonth[i].Description</option>
                                }
                            }
                        </select>
                    </div>

                    <div class="col-md-2 padding-top-30" style="vertical-align:central" id="week">
                        <h4>Week</h4>
                        <select id="ddlWeek" class="form-control ddlWeek" style="width:100%">
                            @for (int x = 1; x <= Model.JumlahWeek; x++)
                            {
                                if (x == (Model.Week))
                                {
                                    <option value="@x" selected="selected">Minggu Ke-@x</option>
                                }
                                else
                                {
                                    if (x <= Model.Week)
                                    {
                                        <option value="@x">Minggu Ke-@x</option>
                                    }
                                }
                            }
                        </select>
                    </div>
                    <div class="col-md-2 padding-top-30">
                        <h4>Kategori</h4>
                        <select id="ddlCategory" class="form-control ddlCategory" style="width:100%;">
                            <option value="SO" selected="selected">SO</option>
                            <option value="Kpi">KPI</option>
                            <option value="Direktorat">Direktorat</option>
                            <option value="KategoriProyek">Kategori Proyek</option>
                            <option value="JenisProyek">Jenis Proyek</option>
                        </select>
                    </div>
                    <div class="col-md-2 padding-top-30" style="text-align:center">
                        <h4>&nbsp;</h4>
                        <button class="btn btn-success" onclick="Search()"><i class="fa fa-search"></i> Search</button>
                        <button class="btn btn-success" onclick="ExportToExcel()"><i class="fa fa-download"></i> Export</button>
                    </div>

                </div>
            </div>
        </section>
    </div>
</div>


<div class="row">
    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
        <section class="box">
            <div class="content-body">

                <div class="row padding-bottom-25" style="text-align:center;">
                    <h3><label>Grafik Pencapaian</label></h3>
                    <div id="overallCapaianFisik"></div>
                    <div id="overallCapaianKpi"></div>
                </div>
            </div>
        </section>
    </div>
</div>

<div class="row">
    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
        <section class="box">
            <div class="content-body">
                <div class="row padding-bottom-25" style="text-align:center;">
                    <h3><label>Detail Proyek</label></h3>
                </div>
                <div class="row padding-top-0">
                    <div id="capaianFisik" class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                        <table id="tblReport" class="display" style="width:100%">
                            <thead>
                                <tr>
                                    <th>Category Code</th>
                                    <th>Project Number</th>
                                    <th>Project Name</th>
                                    <th style="text-align:center">Realisasi Capaian (%)</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div id="capaianKpi" class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                        <table id="tblReportKpi" class="display" style="width:100%">
                            <thead>
                                <tr>
                                    <th>Category Code</th>
                                    <th>Project Number</th>
                                    <th>Project Name</th>
                                    <th style="text-align:center">Capaian KPI (%)</th>
                                    <th style="text-align:center">Poin</th>
                                    <th>Bobot</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>
    </div>
</div>

<script src="~/Scripts/jquery.dataTables.min.js"></script>
<script>

    $(document).ready(function () {
        document.getElementById("overallCapaianFisik").style.display = "none";
        document.getElementById("overallCapaianKpi").style.display = "none";
        $('#capaianFisik').hide();
        $('#capaianKpi').hide();
        $('#tblListForecast').DataTable({
            "bLengthChange": false,
            searching: true,
            "scrollX": true,
            info: false,
            "paging": true
        });
        $('.ddlYear').select2({
            placeholder: 'Pilih Tahun'
        });
        $('.ddlMonth').select2({
            placeholder: 'Pilih Bulan'
        });
        $('.ddlWeek').select2({
            placeholder: 'Pilih Minggu'
        });
        $('.ddlJenisCapaian').select2({
            placeholder: 'Pilih Jenis Capaian'
        });
        $('.ddlCategory').select2({
            placeholder: 'Pilih Kategori'
        });
        $('.ddlTW').select2({
            placeholder: 'Pilih TW'
        });
        //OnOnchangeDdlMonth();
        // -- Tab -- \\
        //$('.tab-group').tabify();
    });

    function format(d, data) {
        debugger;
        var Html = '';
        Html =
            '<div class="row padding-top-0"><div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">' +
            '<table id="tblReportChild' + d.IDProgram + '" class="cell-border" style="width:100%">' +
            '<thead>' +
            '    <tr>' +
            '        <th style="text-align:left; white-space:nowrap">Project Number</th>' +
            '        <th rowspan="2" style="text-align:left; white-space:nowrap">Project Name</th>' +
            '        <th rowspan="2" style="text-align:center; white-space:nowrap">Capaian</th>' +
            '    </tr>' +
            '</thead>';

        Html = Html +
            '<tbody>';

        for (var i = 0; i < data.length; i++) {

            Html = Html +
                '   <tr>' +
                '       <td style="text-align:left">' + data[i].ProjectNo + '</td>' +
                '       <td style="text-align:left">' + data[i].ProjectName + '</td>' +
                '       <td style="text-align:left">' + data[i].RealisasiPencapaian + '</td>' +
                '   </tr>';
        }

        Html = Html +
            '</tbody>';
        Html = Html + '</table></div></div>';
        return Html;
    }


    function OnOnchangeDdlYear(CurrentYear, CurrentMonth) {
        var ListMonth = @Html.Raw(Json.Encode(GlobalHelper.ListDropDowMonth()));
        var Year = $('#ddlYear').val();
        var select = document.getElementById("ddlMonth");
        select.innerHTML = "";
        if (Year == CurrentYear) {
            for (var i = 0; i < 12; i++) {
                if (ListMonth[i].Month == CurrentMonth) {
                    select.innerHTML += "<option value=\"" + ListMonth[i].Month + "\">" + ListMonth[i].Description + "</option>";
                    i = 12;
                }
                else {
                    select.innerHTML += "<option value=\"" + ListMonth[i].Month + "\">" + ListMonth[i].Description + "</option>";
                }
            }
        } else {
            for (var i = 0; i < 12; i++) {
                select.innerHTML += "<option value=\"" + ListMonth[i].Month + "\">" + ListMonth[i].Description + "</option>";
            }
        }
        OnOnchangeDdlMonth();
    }

    function ExportToExcel() {
        window.open('@Url.Action("LaporanSeriesPerTahunExcel", "Laporan")' + '?JenisCapaian=' + $('#ddlJenisCapaian').val() + '&Year=' + $('#ddlYear').val() + '&Month=' + $('#ddlMonth').val() + '&Week=' + $('#ddlWeek').val() + '&Category=' + $('#ddlCategory').val() + '&Tw=' + $('#ddlTW').val() );
    }

    @*function OnOnchangeDdlMonth() {
        var data = {
            Year: $('#ddlYear').val(),
            Month: $('#ddlMonth').val()
        }
        var da = new Date();
        var Cyear = da.getFullYear();
        var Cmonth = da.getMonth() + 1;
        $.ajax({
            type: "GET",
            url: '@Url.Action("GetDdlWeek", "Beranda")',
            data: data,
            traditional: true,
            success: function (result) {
                var select = document.getElementById("ddlWeek");

                // Optional: Clear all existing options first:
                select.innerHTML = "";
                // Populate list with options:
                if (result.Month < Cmonth || result.Year < Cyear) {
                    for (var i = 1; i <= result.JumlahWeek; i++) {
                        var opt = i;
                        select.innerHTML += "<option value=\"" + opt + "\">Minggu Ke-" + opt + "</option>";
                    }
                }
                else {
                    for (var i = 1; i <= result.Week; i++) {
                        var opt = i;
                        select.innerHTML += "<option value=\"" + opt + "\">Minggu Ke-" + opt + "</option>";
                    }
                }
            }
        });
    }*@

    function OnOnchangeDdlMonth() {
        var data = {
            Year: $('#ddlYear').val(),
            Month: parseInt($('#ddlMonth').val())
        }
        var da = new Date();
        var Cyear = da.getFullYear();
        var Cmonth = da.getMonth() + 1;
        $.ajax({
            type: "GET",
            url: '@Url.Action("GetDdlWeek", "Beranda")',
            data: data,
            traditional: true,
            success: function (result) {
                var select = document.getElementById("ddlWeek");

                // Optional: Clear all existing options first:
                select.innerHTML = "";
                // Populate list with options:
                if (result.Month < Cmonth || result.Year < Cyear) {
                    for (var i = 1; i <= result.JumlahWeek; i++) {
                        var opt = i;
                        select.innerHTML += "<option value=\"" + opt + "\">Minggu Ke-" + opt + "</option>";
                    }
                }
                else {
                    for (var i = 1; i <= result.Week; i++) {
                        var opt = i;
                        select.innerHTML += "<option value=\"" + opt + "\">Minggu Ke-" + opt + "</option>";
                    }
                }
            }
        });
    }


    function Search() {
        if ($('#ddlJenisCapaian').val() == "Fisik") {
            GetTimeSeriesFisik();
        }
        else {
            GetTimeSeriesKpi();
        }
    }

    function GetTimeSeriesFisik() {
        var data = {
            //AchievementType: $('#ddlJenisCapaian').val(),
            Year: $('#ddlYear').val(),
            Month: $('#ddlMonth').val(),
            Week: $('#ddlWeek').val(),
            Category: $('#ddlCategory').val()
        }

        $.ajax({
            type: "GET",
            url: '@Url.Action("GetSeriesGrafikCapaianFisik", "Laporan")',
            data: data,
            traditional: true,
            success: function (result) {
                if (result.Result === "Success") {
                    $('#capaianKpi').hide();
                    $('#capaianFisik').show();
                    $('#tblReport').DataTable().destroy();
                    $('#tblReport').DataTable({
                        "bLengthChange": false,
                        "autoWidth": false,
                        searching: true,
                        "scrollX": true,
                        info: false,
                        data: result.Data.DetailModel,
                        "paging": true,
                        "columns": [
                            {
                                "data": "Name",
                                "className": "text-left"
                            },
                            {
                                "data": "ProjectNo",
                                "className": "text-left"
                            },
                            {
                                "data": "ProjectName",
                                "className": "text-left"
                            },
                            {
                                "data": "RealisasiPencapaian",
                                "className": "text-center"
                            }
                        ]
                    });
                    GetChart(result.Data.HeaderModel);
                } else {
                    alert(result.Message);
                }
            },
            error: function (xhr, ajaxOptions, thrownError) {
                alert(xhr.status);
                alert(thrownError);
            }
        });
    }

    function GetTimeSeriesKpi() {
        var data = {
            //AchievementType: $('#ddlJenisCapaian').val(),
            Year: $('#ddlYear').val(),
            Month: $('#ddlMonth').val(),
            Week: $('#ddlWeek').val(),
            Category: $('#ddlCategory').val(),
            Tw: $('#ddlTW').val()
        }

        $.ajax({
            type: "GET",
            url: '@Url.Action("GetSeriesGrafikCapaianKpi", "Laporan")',
            data: data,
            traditional: true,
            success: function (result) {
                if (result.Result === "Success") {
                    console.log(result.Data);
                    $('#capaianFisik').hide();
                    $('#capaianKpi').show();
                    $('#tblReportKpi').DataTable().destroy();
                    $('#tblReportKpi').DataTable({
                        "bLengthChange": false,
                        "autoWidth": false,
                        searching: true,
                        "scrollX": true,
                        info: false,
                        data: result.Data.DetailModel,
                        "paging": true,
                        "columns": [
                            {
                                "data": "Name",
                                "className": "text-left"
                            },
                            {
                                "data": "ProjectNo",
                                "className": "text-left"
                            },
                            {
                                "data": "ProjectName",
                                "className": "text-left"
                            },
                            {
                                "data": "RealisasiPencapaian",
                                "className": "text-center"
                            },
                            {
                                "data": "Poin",
                                "className": "text-center"
                            },
                            {
                                "data": "Bobot",
                                "className": "text-center"
                            }
                        ]
                    });
                    GetChartKpi(result.Data.HeaderModel);
                } else {
                    alert(result.Message);
                }
            },
            error: function (xhr, ajaxOptions, thrownError) {
                alert(xhr.status);
                alert(thrownError);
            }
        });
    }

    function GetChart(data) {
        var dataAll = [];
        for (var x in data) {
            var obj = data[x];
            var dataRows = {
                name: obj.Name,
                data: [obj.RataRataCapaian]
            }
            dataAll.push(dataRows);
        }
        document.getElementById("overallCapaianKpi").style.display = "none";
        document.getElementById("overallCapaianFisik").style.display = "block";
        Highcharts.chart('overallCapaianFisik', {
            chart: {
                type: 'column'
            },
            title: {
                text: ''
            },
            exporting: {
                enabled: true
            },
            credits: {
                enabled: false
            },
            xAxis: {
                categories: [''],
            },
            yAxis: {
                allowDecimals: false,
                title: {
                    text: 'Rata-Rata Capaian (%)'
                }
            },
            series: dataAll
        });
    }

    function GetChartKpi(data) {
        var dataAll = [];
        for (var x in data) {
            var obj = data[x];
            var dataRows = {
                name: obj.Name,
                data: [obj.CapaianKpi]
            }
            dataAll.push(dataRows);
        }
        console.log(dataAll);
        document.getElementById("overallCapaianFisik").style.display = "none";
        document.getElementById("overallCapaianKpi").style.display = "block";
        Highcharts.chart('overallCapaianKpi', {
            chart: {
                type: 'column'
            },
            title: {
                text: ''
            },
            exporting: {
                enabled: true
            },
            credits: {
                enabled: false
            },
            xAxis: {
                categories: [''],
            },
            yAxis: {
                allowDecimals: true,
                title: {
                    text: 'Capaian KPI '
                }
            },
            series: dataAll
        });
    }

    function OnOnchangeDdlJenisCapaian() {
        if ($('#ddlJenisCapaian').val() == "Fisik") {
            $('#triwulan').hide();
            $('#month').show();
            $('#week').show();
            //$("#ddlCategory option:selected").prop("selected", false);
            //$("#ddlCategory option:first").prop("selected", "selected");
        } else {
            $('#triwulan').show();
            $('#month').hide();
            $('#week').hide();
            //$("#ddlCategory option:selected").prop("selected", false);
            //$("#ddlCategory option:first").prop("selected", "selected");
        }

    }

</script>
