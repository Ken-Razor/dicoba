@*@model LPS_ProjectManagement.Models.ReportModels.LaporanForecastViewModel*@
@model LPS_ProjectManagement.Models.ReportModels.LaporanForecastParamModel


@{
    ViewBag.Title = "Forecast";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@using LPS_ProjectManagement.Helper;

@*<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
        <section class="box">
            <header class="panel_header">
                <h2 class="title pull-left">Table Forecast</h2>
            </header>
            <div class="content-body padding-top-45">
                <div class="row padding-top-10">
                    <div class="col-md-12 col-sm-12 col-xs-12 padding-left-0 padding-right-0">
                        <table id="tblListForecast" class="display" style="width:100%">
                            <thead>
                                <tr>
                                    <th class="text-center">
                                        Periode
                                    </th>
                                    <th class="text-center">
                                        Realisasi
                                    </th>
                                    <th class="text-center">
                                        Forecast
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Model.ForecastModel)
                                {
                                    <tr>
                                        <td style="text-align:left;">
                                            @Html.DisplayFor(modelItem => item.Periode)
                                        </td>
                                        @if (item.Realisasi != null)
                                        {
                                            <td style="text-align: center !important;">
                                                @Html.DisplayFor(modelItem => item.Realisasi)%
                                            </td>
                                        }
                                        else
                                        {
                                            <td></td>
                                        }
                                        @if (item.Forecast != null)
                                        {
                                            <td style="text-align: center !important;">
                                                @Html.DisplayFor(modelItem => item.Forecast)%
                                            </td>
                                        }
                                        else
                                        {
                                            <td></td>
                                        }
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="row">
                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                        <section class="box">
                            <div class="content-body">
                                <div class="row padding-bottom-25" style="text-align:center;">
                                    <h3><label>TIME SERIES FORECASTING</label></h3>
                                    <h4><label>@Model.Param.ForecastMethodName</label></h4>
                                </div>
                                <div id="ProjectTimeSeries"></div>
                            </div>
                        </section>
                    </div>
                </div>

            </div>
        </section>
    </div>*@

<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
    <section class="box">
        <header class="panel_header">
            <h2 class="title pull-left">Proyek : @Model.ProjectName</h2>
        </header>
        <div class="content-body padding-top-45">
            <div class="row padding-15">
                <div class="col-md-2 padding-top-30">
                    <h4>METODE FORECAST</h4>
                    <select id="ddlMetode" class="form-control ddlMetode" style="width:100%;">
                        <option value=1 selected="selected">Naive</option>
                        <option value=2>3-SMA</option>
                        <option value=3>3-WMA</option>
                        <option value=4>ES</option>
                        <option value=5>ARS</option>
                        <option value=6>Linear</option>
                    </select>
                </div>
                <div class="col-md-4" style="text-align:left;padding-top:50px">
                    <button class="btn btn-success" onclick="Forecast()">Generate</button>
                    <button class="btn btn-success" onclick="ExportToExcel()"><i class="fa fa-download"></i>Export To Excel</button>
                </div>
            </div>

            <div class="row padding-top-10">
                <div class="col-md-12 col-sm-12 col-xs-12 padding-left-0 padding-right-0">
                    <table id="tblListForecast" class="display" style="width:100%">
                        <thead>
                            <tr>
                                <th class="text-center">
                                    Periode
                                </th>
                                <th class="text-center">
                                    Realisasi (%)
                                </th>
                                <th class="text-center">
                                    Forecast (%)
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                    <section class="box">
                        <div class="content-body">
                            <div class="row padding-bottom-25" style="text-align:center;">
                                <h3><label>TIME SERIES FORECASTING</label></h3>
                            </div>
                            <div id="ProjectTimeSeries"></div>
                        </div>
                    </section>
                </div>
            </div>

        </div>
    </section>
</div>

<script>
    var model = '@Html.Raw(Json.Encode(Model))';
    var jsonModel = JSON.parse(model);
    $(document).ready(function () {
        $('#tblListForecast').DataTable({
            "bLengthChange": false,
            searching: false,
            "scrollX": true,
            info: false,
            "paging": true,
            "bSort" : false
        });
        $('.ddlMetode').select2({
            placeholder: 'Pilih Metode'
        });
    });

    function ExportToExcel() {
        var forecastMethodName = $('#ddlMetode option:selected').text();
        window.open('@Url.Action("ExportLaporanForecastExcel", "Laporan")' + '?ProjectHeaderId=' + jsonModel.ProjectHeaderId + '&ForecastMethod=' + $('#ddlMetode').val() + '&IsTransformasi=' + jsonModel.IsTransformasi + '&ProjectName=' + jsonModel.ProjectName + '&ForecastMethodName=' + forecastMethodName );
    }

    function Forecast() {

        data = {
            ProjectHeaderId: jsonModel.ProjectHeaderId,
            IsTransformasi: jsonModel.IsTransformasi,
            ForecastMethod: $('#ddlMetode').val()
        }

        $.ajax({
            url: '@Url.Action("GenerateTimeSeriesForecast", "Laporan")',
            data: data,
            success: function (result) {
                if (result.Result === "Success") {

                    $('#tblListForecast').DataTable().destroy();

                    $('#tblListForecast').DataTable({
                        "bLengthChange": false,
                        "autoWidth": false,
                        searching: false,
                        "scrollX": true,
                        info: false,
                        data: result.Data,
                        "paging": true,
                        "bSort": false,
                        "columns": [
                            {
                                "data": "Periode",
                                "className": "text-left"
                            },
                            {
                                "data": "Realisasi",
                                "className": "text-center"
                            },
                            {
                                "data": "Forecast",
                                "className": "text-center"
                            },
                        ]
                    });
                    GetTimeSeriesChart(jsonModel.IsTransformasi,result.Data);
                } else {
                    alert(result.Message);
                }

            },
            error: function (xhr, ajaxOptions, thrownError) {
                debugger;
                    alert(xhr.status);
                    alert(thrownError);
            }
        });
    }

    function GetTimeSeriesChart(isTransformasi, data) {

        var Realisasi = [];
        var Forecast = [];
        var Periode = [];

        Periode.push('-');

        for (var x in data) {
            var obj = data[x];
            Periode.push(obj.Periode);
            Realisasi.push(obj.Realisasi);
            Forecast.push(obj.Forecast);
        }

        if (isTransformasi) {
            Highcharts.chart('ProjectTimeSeries', {
                title: {
                    text: ''
                },
                exporting: {
                    enabled: true
                },
                credits: {
                    enabled: false
                },
                yAxis: {
                    title: {
                        text: 'Percentage'
                    }
                },
                xAxis: {
                    categories: Periode
                },
                legend: {
                    layout: 'vertical',
                    align: 'right',
                    verticalAlign: 'middle'
                },
                plotOptions: {
                    series: {
                        label: {
                            connectorAllowed: false
                        },
                        pointStart: 1,
                        cursor: 'pointer',
                    }
                },
                series: [{
                    name: 'Realisasi',
                    data: Realisasi
                }, {
                    name: 'Forecast',
                    data: Forecast
                }],
                responsive: {
                    rules: [{
                        condition: {
                            maxWidth: 500
                        },
                        chartOptions: {
                            legend: {
                                layout: 'horizontal',
                                align: 'center',
                                verticalAlign: 'bottom'
                            }
                        }
                    }]
                }

            });

        }
        else {
            Highcharts.chart('ProjectTimeSeries', {

                title: {
                    text: ''
                },
                exporting: {
                    enabled: true
                },
                credits: {
                    enabled: false
                },
                yAxis: {
                    title: {
                        text: 'Percentage'
                    }
                },
                xAxis: {
                    categories: Periode
                },
                legend: {
                    layout: 'vertical',
                    align: 'right',
                    verticalAlign: 'middle',
                },
                plotOptions: {
                    series: {
                        label: {
                            connectorAllowed: false
                        },
                        pointStart: 1,
                        cursor: 'pointer',
                    }
                },
                series: [{
                    name: 'Realisasi',
                    data: Realisasi
                }, {
                    name: 'Forecast',
                    data: Forecast
                }],
                responsive: {
                    rules: [{
                        condition: {
                            maxWidth: 500
                        },
                        chartOptions: {
                            legend: {
                                layout: 'horizontal',
                                align: 'center',
                                verticalAlign: 'bottom'
                            }
                        }
                    }]
                }
            });
        }
    }
</script>

@*<script>
    $(document).ready(function () {
        var model = '@Html.Raw(Json.Encode(Model))';
        var jsonModel = JSON.parse(model);
        $('#tblListForecast').DataTable({
            "bLengthChange": false,
            searching: false,
            "scrollX": true,
            info: false,
            "paging": true,
            "bSort" : false
        });

        GetTimeSeriesChart(jsonModel.Param.IsTransformasi,jsonModel.ForecastModel);
    });

    function GetTimeSeriesChart(isTransformasi, data) {

        var Realisasi = [];
        var Forecast = [];
        var Periode = [];

        Periode.push('-');

        for (var x in data) {
            var obj = data[x];
            Periode.push(obj.Periode);
            Realisasi.push(obj.Realisasi);
            Forecast.push(obj.Forecast);
        }

        if (isTransformasi) {
            Highcharts.chart('ProjectTimeSeries', {
                title: {
                    text: ''
                },
                exporting: {
                    enabled: false
                },
                credits: {
                    enabled: false
                },
                yAxis: {
                    title: {
                        text: 'Percentage'
                    }
                },
                xAxis: {
                    categories: Periode
                },
                legend: {
                    layout: 'vertical',
                    align: 'right',
                    verticalAlign: 'middle'
                },
                plotOptions: {
                    series: {
                        label: {
                            connectorAllowed: false
                        },
                        pointStart: 1,
                        cursor: 'pointer',
                    }
                },
                series: [{
                    name: 'Realisasi',
                    data: Realisasi
                }, {
                    name: 'Forecast',
                    data: Forecast
                }],
                responsive: {
                    rules: [{
                        condition: {
                            maxWidth: 500
                        },
                        chartOptions: {
                            legend: {
                                layout: 'horizontal',
                                align: 'center',
                                verticalAlign: 'bottom'
                            }
                        }
                    }]
                }

            });

        }
        else {
            Highcharts.chart('ProjectTimeSeries', {

                title: {
                    text: ''
                },
                exporting: {
                    enabled: false
                },
                credits: {
                    enabled: false
                },
                yAxis: {
                    title: {
                        text: 'Percentage'
                    }
                },
                xAxis: {
                    categories: Periode
                },
                legend: {
                    layout: 'vertical',
                    align: 'right',
                    verticalAlign: 'middle',
                },
                plotOptions: {
                    series: {
                        label: {
                            connectorAllowed: false
                        },
                        pointStart: 1,
                        cursor: 'pointer',
                    }
                },
                series: [{
                    name: 'Realisasi',
                    data: Realisasi
                }, {
                    name: 'Forecast',
                    data: Forecast
                }],
                responsive: {
                    rules: [{
                        condition: {
                            maxWidth: 500
                        },
                        chartOptions: {
                            legend: {
                                layout: 'horizontal',
                                align: 'center',
                                verticalAlign: 'bottom'
                            }
                        }
                    }]
                }
            });
        }
    }
</script>*@