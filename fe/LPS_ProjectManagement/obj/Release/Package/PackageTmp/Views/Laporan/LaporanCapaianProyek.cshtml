
@{
    ViewBag.Title = "Laporan Capaian Proyek";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@using LPS_ProjectManagement.Helper;
<style>
    .circle {
        border-radius: 50%;
        width: 5px;
        height: 5px;
        margin: auto;
        padding: 5px;
        /* width and height can be anything, as long as they're equal */
    }

    thead, th, tbody, td {
        text-align: center;
    }

    .th {
        white-space: nowrap;
        text-align: center;
    }
    .align-l{
        text-align: left;
    }
</style>

<div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
    <div class="content-body">

        <div class="row padding-top-30">
            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                <div class="col-md-1"><i class="material-icons pull-right" style="color:blue">brightness_1</i></div>
                <div class="col-md-2"><label>Pencapaian di atas target <br />( >= 110% )</label></div>
                <div class="col-md-1"><i class="material-icons pull-right" style="color:green">brightness_1</i></div>
                <div class="col-md-2"><label>Pencapaian sesuai target <br />( >= 100% dan < 110%)</label></div>
                <div class="col-md-1"><i class="material-icons pull-right" style="color:yellow">brightness_1 </i></div>
                <div class="col-md-2"><label>Pencapaian sedikit di bawah target <br />(  >= 85% dan < 100% )</label></div>
                <div class="col-md-1"><i class="material-icons pull-right" style="color:red">brightness_1 </i></div>
                <div class="col-md-2"><label>Pencapaian jauh di bawah target <br />( < 85% )</label></div>
            </div>
        </div>

        <div class="row padding-top-45">

            <div class="col-lg-2 col-md-3 col-sm-12 col-xs-12">
                <div class="form-group has-warning">
                    <label class="form-label label-header" style="font-size: 13px" for="ddlTipe">Jenis Transformasi</label>
                    <span class="desc"></span>
                    <div class="controls">
                        <select id="ddlTipe" class="form-control ddlTipe" style="width:100%" onchange="week()">
                            <option value="2">ALL</option>
                            <option value="1">Transformasi</option>
                            <option value="0">Non Transformasi</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="col-lg-2 col-md-2 col-sm-12 col-xs-12" id="week" style="display: none">
                <div class="form-group has-warning">
                    <label class="form-label label-header" for="ddlWeek">Week</label>
                    <span class="desc"></span>
                    <div class="controls">
                        <select id="ddlWeek" class="form-control ddlWeek" style="width:100%">
                            <option value="1" selected>Week 1</option>
                            <option value="2">Week 2</option>
                            <option value="3">Week 3</option>
                            <option value="4">Week 4</option>
                            <option value="5">Week 5</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="col-lg-2 col-md-2 col-sm-12 col-xs-12">
                <div class="form-group has-warning">
                    <label class="form-label label-header" for="ddlYear">Tahun</label>
                    <span class="desc"></span>
                    <div class="controls">
                        <select id="ddlYear" class="form-control ddlYear" style="width:100%;" onchange="OnOnchangeDdlYear(@DateTime.Now.Year, @DateTime.Now.Month)">
                            @for (int year = Convert.ToInt32(DateTime.Now.Year.ToString()) - 10; year <= Convert.ToInt32(DateTime.Now.Year.ToString()); year++)
                            {
                                if (Convert.ToInt32(DateTime.Now.Year.ToString()) == year)
                                {
                                    <option value=@year selected="selected">@year</option>
                                }
                                else
                                {
                                    <option value=@year>@year</option>
                                }
                            }
                        </select>
                    </div>
                </div>
            </div>

            <div class="col-lg-2 col-md-2 col-sm-12 col-xs-12">
                <div class="form-group has-warning">
                    <label class="form-label label-header" for="ddlMonth">Bulan</label>
                    <span class="desc"></span>
                    <div class="controls">
                        <select id="ddlMonth" class="form-control ddlMonth" style="width:100%">
                            @{ var ListMonth = GlobalHelper.ListDropDowMonth(); }

                            @for (int i = 0; i < 12; i++)
                            {
                                if (ListMonth[i].Month == DateTime.Now.Month)
                                {
                                    <option value="@ListMonth[i].Month" selected="selected">@ListMonth[i].Description</option>
                                    i = 12;
                                }
                                else
                                {
                                    <option value="@ListMonth[i].Month">@ListMonth[i].Description</option>
                                }
                            }
                        </select>
                    </div>
                </div>
            </div>

            <div class="col-lg-4 col-md-4 col-sm-12 col-xs-12">
                <div class="form-group has-warning">
                    <label class="form-label label-header" for="btnSearch">&nbsp;</label>
                    <span class="desc"></span>
                    <div class="controls">
                        <button onclick="Search()" type="button" class="btn btn-info btn-corner"><i class="fa fa-search"></i>&nbsp;&nbsp; Search</button>
                        &nbsp;
                        <button onclick="ExportToPdf()" type="button" class="btn btn-warning btn-corner">@*<a href="">*@<i class="fa fa-print"></i>&nbsp;&nbsp; Export To PDF@*</a>*@</button>
                        <button onclick="DownloadAllData()" type="button" class="btn btn-warning btn-corner">@*<a href="">*@<i class="fa fa-print"></i>&nbsp;&nbsp; Export To Excel@*</a>*@</button>                    
                    </div>
                </div>
            </div>

        </div>

        <div id="table" class="row">

            <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                <table id="tblReportCapaianProyek" class="table table-bordered" style="width:100%">
                    <thead>
                        <tr>
                            <th>Program</th>
                            <th>Anggaran (Rp.Juta)</th>
                            <th>Pencapaian (%)</th>
                            <th>Status</th>
                            <th>Realisasi Anggaran (%)</th>
                            <th>Real + Komit (%)</th>

                            @*<th class="th" style="width:50%; color:black; border: none;">
                                Program
                            </th>
                            <th class="th" style="width:10%; color:black; border: none;">
                                Anggaran <br /> (Rp.Juta)
                            </th>
                            <th class="th" colspan="2" style="color:black; width:20%; border: none;">
                                Status Pencapaian <br /> <span id="bln1"></span>
                            </th>*@
                            @*<th class="th" style="color:black; width:10%">
                                Rata Pencapaian <br /> <span id="bln2"></span>
                            </th>*@
                            @*<th class="th" style="width:10%; color:black; border: none;">
                                Realisasi Ang. <br /> <span id="bln3"></span>
                            </th>
                            <th class="th" style="width:10%; color:black; border: none;">
                                Real + Komit <br /> <span id="bln4"></span>
                            </th>*@
                        </tr>
                        @*<tr>
                            <th class="th" style="display: none; width: 50%; border: none;"></th>
                            <th class="th" style="display: none; width: 10%; border: none;"></th>
                            <th class="th" style="display: none; width: 10%; border: none;"></th>
                            <th class="th" style="display: none; width: 10%; border: none;"></th>
                            <th class="th" style="display: none; width: 10%; border: none;"></th>
                            <th class="th" style="display: none; width: 10%; border: none;"></th>
                        </tr>*@
                    </thead>
                    <tbody></tbody>

                </table>
            </div>

        </div>

    </div>
</div>

<script>

    var urlLaporanCapaianProyekSearch = '@Url.Action("LaporanCapaianProyekSearch", "Laporan")';

    $(document).ready(function () {

        $('#tblReportCapaianProyek').DataTable({
            "bLengthChange": false,
            searching: true,
            "scrollX": true,
            info: false
        });
        

        $('.ddlTipe').select2({
            placeholder: 'ALL',
            selectOnClose: true
        });

        $('.ddlWeek').select2({
            placeholder: 'Pilih Week',
            selectOnClose: true
        });

        $('.ddlYear').select2({
            placeholder: 'Pilih Tahun',
            selectOnClose: true
        });

        $('.ddlMonth').select2({
            placeholder: 'Pilih Bulan',
            selectOnClose: true
        });

    });

    function week() {
        var week = document.getElementById("ddlTipe").value;
        if (week == 7) {
            $('#week').show();
        } else {
            $('#week').hide();
        }
    }

    function MonYear() {
        var bulan = ["Jan", "Feb", "Mar", "Apr", "Mei", "Juni", "Juli", "Agu", "Sep", "Okt", "Nov", "Des"];
        var Periode = bulan[$('#ddlMonth').val() - 1] + " " + $('#ddlYear').val();

        $('#bln1').text(Periode);
        $('#bln2').text(Periode);
        $('#bln3').text(Periode);
        $('#bln4').text(Periode);

        $('#bln5').text(Periode);
        $('#bln6').text(Periode);
        $('#bln7').text(Periode);
        $('#bln8').text(Periode);
    }

    function Search() {

        MonYear();
        document.getElementById('tblReportCapaianProyek').style.fontFamily = "'Segoe UI', Arial, Helvetica, sans-serif";

        var param = {
            tipe: $('#ddlTipe').val(),
            week: 0,
            month: $('#ddlMonth').val(),
            year: $('#ddlYear').val()
        }

        $.ajax({
            url: urlLaporanCapaianProyekSearch,
            data: param,
            success: function (result) {

                $('#tblReportCapaianProyek').DataTable().destroy();
                //$('#tblReportSummary').empty();
                //$("#tblReportSummary tr").remove();

                $('#tblReportCapaianProyek').DataTable({
                    "bLengthChange": false,
                    searching: true,
                    "scrollX": true,
                    info: false,
                    data: result.Data,
                    "columns": [
                        { "data": "NamaProgram", "className": "align-l", "width" : "50%" },
                        { "data": "TotalAnggaran", "className": "text-right", "width": "10%"},
                        { "data": "RataPencapain", "width": "10%", "className": "text-right" },
                        { "data": "Status", "className": "text-right", "width": "10%" },
                        { "data": "Realisasi", "width": "10%", "className": "text-right"},
                        { "data": "Realkomit", "width": "10%", "className": "text-right"}
                    ],
                    "footerCallback": function (row, data, start, end, display) {
                        var api = this.api(), data;

                        // Remove the formatting to get integer data for summation
                        var intVal = function (i) {
                            return typeof i === 'string' ?
                                i.replace(/[\$,]/g, '') * 1 :
                                typeof i === 'number' ?
                                    i : 0;
                        };

                        // Total over all pages
                        total1 = api
                            .column(1)
                            .data()
                            .reduce(function (a, b) {
                                return intVal(a) + intVal(b);
                            }, 0);

                        total2 = api
                            .column(2)
                            .data()
                            .reduce(function (a, b) {
                                return intVal(a) + intVal(b);
                            }, 0);

                        total3 = api
                            .column(3)
                            .data()
                            .reduce(function (a, b) {
                                return intVal(a) + intVal(b);
                            }, 0);

                        total4 = api
                            .column(4)
                            .data()
                            .reduce(function (a, b) {
                                return intVal(a) + intVal(b);
                            }, 0);

                        total5 = api
                            .column(5)
                            .data()
                            .reduce(function (a, b) {
                                return intVal(a) + intVal(b);
                            }, 0);


                        // Total over this page
                        pageTotal1 = api
                            .column(1, { page: 'current' })
                            .data()
                            .reduce(function (a, b) {
                                return intVal(a) + intVal(b);
                            }, 0);

                        pageTotal2 = api
                            .column(2, { page: 'current' })
                            .data()
                            .reduce(function (a, b) {
                                return intVal(a) + intVal(b);
                            }, 0);

                        pageTotal3 = api
                            .column(3, { page: 'current' })
                            .data()
                            .reduce(function (a, b) {
                                return intVal(a) + intVal(b);
                            }, 0);

                        pageTotal4 = api
                            .column(4, { page: 'current' })
                            .data()
                            .reduce(function (a, b) {
                                return intVal(a) + intVal(b);
                            }, 0);

                        pageTotal5 = api
                            .column(5, { page: 'current' })
                            .data()
                            .reduce(function (a, b) {
                                return intVal(a) + intVal(b);
                            }, 0);

                        // Update footer
                        $(api.column(1).footer()).html(
                            pageTotal1 /*+ ' (' + total1 + ' total)'*/
                        );

                        //$(api.column(2).footer()).html(
                        //    pageTotal2 + ' (' + total2 + ' total)'
                        //);

                        //$(api.column(3).footer()).html(
                        //    pageTotal3 + ' (' + total3 + ' total)'
                        //);

                        $(api.column(4).footer()).html(
                            pageTotal4 + '%' /*+ ' (' + total4 + '% total)'*/
                        );

                        $(api.column(5).footer()).html(
                            pageTotal5 + '%' /*+ ' (' + total5 + '% total)'*/
                        );
                    }
                });

            }
        });

    }

    function ExportToPdf() {
        var Month = $('#ddlMonth').val();
        var Year = $('#ddlYear').val();
        var Week = 0;
        var isTransformasi = $('#ddlTipe').val();
        if (isTransformasi == 1) {
            Week = $('#ddlWeek').val()
        }

       
        location.href = '@Url.Action("PrintCapaianProyek", "Exporting")' + '?week=' + Week + '&month=' + Month + '&year=' + Year + '&jenis=Trans|' + isTransformasi ;
    }
    
    function OnOnchangeDdlYear(CurrentYear, CurrentMonth) {

        var ListMonth = @Html.Raw(Json.Encode(GlobalHelper.ListDropDowMonth()));

        debugger;

        var Year = $('#ddlYear').val();
        var select = document.getElementById("ddlMonth");

        select.innerHTML = "";

        if (Year == CurrentYear) {
            for (var i = 0; i < 12; i++) {
                if (ListMonth[i].Month == CurrentMonth) {
                    select.innerHTML += "<option value=\"" + ListMonth[i].Month + "\">" + ListMonth[i].Description + "</option>";
                    i = 12;
                }
                else {
                    select.innerHTML += "<option value=\"" + ListMonth[i].Month + "\">" + ListMonth[i].Description + "</option>";
                }
            }
        } else {
            for (var i = 0; i < 12; i++) {
                select.innerHTML += "<option value=\"" + ListMonth[i].Month + "\">" + ListMonth[i].Description + "</option>";
            }
        }
        
    }

    function DownloadAllData() {
        var Month = $('#ddlMonth').val();
        var Year = $('#ddlYear').val();
        var Week = 0;
        var isTransformasi = $('#ddlTipe').val();
        //location.href = '@Url.Action("ExportExcelAllDataRow", "Laporan")' + '?Year=' + $('#ddlYear').val() + '&Month=' + $('#ddlMonth').val() + '&Week=' + $('#ddlWeek').val();
        window.open('@Url.Action("LaporanProgramPrintint", "Laporan")' + '?year=' + Year + '&month=' + Month + '&week=' + Week + '&tipe=' + isTransformasi );
    }
</script>


