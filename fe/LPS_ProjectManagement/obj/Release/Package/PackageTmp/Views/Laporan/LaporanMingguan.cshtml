@model LPS_ProjectManagement.Models.ReportModels.LaporanInitModel

@{
    ViewBag.Title = "Laporan Mingguan Proyek";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@using LPS_ProjectManagement.Helper;

<style>
    td {
        white-space: nowrap;
    }
</style>

<div class="row">
    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
        <section class="box">
            <div class="content-body padding-15" style=" max-height: none; overflow: auto;">

                <div class="row padding-15">
                    <div class="col-md-4 padding-bottom-0 padding-top-0 padding-left-0 padding-right-0">

                        <div class="col-md-6 padding-top-30">
                            <h4>Year</h4>
                            <select id="ddlYear" class="form-control ddlYear" style="width:100%;" onchange="OnOnchangeDdlYear(@DateTime.Now.Year, @DateTime.Now.Month)">
                                @for (int year = Convert.ToInt32(DateTime.Now.Year.ToString()) - 10; year <= Convert.ToInt32(DateTime.Now.Year.ToString()); year++)
                                {
                                    if (Convert.ToInt32(DateTime.Now.Year.ToString()) == year)
                                    {
                                        <option value=@year selected="selected">@year</option>
                                    }
                                    else
                                    {
                                        <option value=@year>@year</option>
                                    }
                                }
                            </select>
                        </div>

                        <div class="col-md-6 padding-top-30">
                            <h4>Month</h4>
                            <select id="ddlMonth" class="form-control ddlMonth" style="width:100%" onchange="OnOnchangeDdlMonth()">
                                @*@{ var ListMonth = GlobalHelper.ListDropDowMonth(); }

                                @for (int i = 0; i < DateTime.Now.Month; i++)
                                {
                                    if (ListMonth[i].Month == Model.Month)
                                    {
                                        <option value="@ListMonth[i].Month" selected="selected">@ListMonth[i].Description</option>
                                    }
                                    else
                                    {
                                        <option value="@ListMonth[i].Month">@ListMonth[i].Description</option>
                                    }
                                }*@
                                @foreach (var item in Model.ListMonth)
                                {
                                    if (item.Month == Model.DashboardProjectHeaderModel.Month)
                                    {
                                        <option value="@item.Month" selected="selected">@item.Description</option>
                                    }
                                    else
                                    {
                                        <option value="@item.Month">@item.Description</option>
                                    }
                                }
                            </select>
                        </div>

                        <div class="col-md-6 padding-top-30" style="vertical-align:central">
                            <h4>Periode</h4>
                            <select id="ddlWeek" class="form-control ddlWeek" style="width:100%">
                                @for (int x = 1; x <= Model.DashboardProjectHeaderModel.JumlahWeek; x++)
                                {
                                    if (x == (Model.DashboardProjectHeaderModel.Week))
                                    {
                                        <option value="@x" selected="selected">Minggu Ke-@x</option>
                                    }
                                    else
                                    {
                                        if (x <= Model.DashboardProjectHeaderModel.Week)
                                        {
                                            <option value="@x">Minggu Ke-@x</option>
                                        }
                                    }
                                }
                            </select>
                        </div>

                        <div class="col-md-6 padding-top-30">
                            <h4>Unit Kerja</h4>
                            <select id="ddlUnitkerja" class="form-control ddlUnitkerja" style="width:100%" ;>
                                <option value="0">All</option>
                                @foreach (var item in Model.ListDepartment)
                                {
                                    <option value="@item.IDDepartment">@item.DepartmentName</option>
                                }
                            </select>
                        </div>

                        <div class="col-md-6 padding-top-30" style="vertical-align:central" hidden="hidden">
                            <h4>Jenis</h4>
                            <select id="ddlIsTransformasi" class="form-control ddlIsTransformasi" style="width:100%">
                                <option value="0">All</option>
                                <option value="1" selected="selected">Transformasi</option>
                                <option value="2">Non Transformasi</option>
                            </select>
                        </div>

                    </div>

                    <div class="col-md-8 padding-bottom-0 padding-top-0 padding-left-0 padding-right-0">

                        <div class="col-md-4 padding-top-30">
                            <h4>PMO</h4>
                            <select id="ddlPMO" class="form-control ddlPMO" style="width:100%" ;>
                                <option value="0">All</option>
                                @foreach (var item in Model.ListPMO)
                                {
                                    <option value="@item.Username">@item.Nama</option>
                                }
                            </select>
                        </div>

                        <div class="col-md-4 padding-top-30">
                            <h4>Owner</h4>
                            <select id="ddlOwner" class="form-control ddlOwner" style="width:100%" ;>
                                <option value="0">All</option>
                                @foreach (var item in Model.ListOwner)
                                {
                                    <option value="@item.Username">@item.Nama</option>
                                }
                            </select>
                        </div>

                        <div class="col-md-4 padding-top-30">
                            <h4>Sponsor</h4>
                            <select id="ddlSponsor" class="form-control ddlSponsor" style="width:100%" ;>
                                <option value="0">All</option>
                                @foreach (var item in Model.ListSponsor)
                                {
                                    <option value="@item.Username">@item.Nama</option>
                                }
                            </select>
                        </div>

                    </div>

                </div>

                <div class="row padding-15">

                    <div class="col-md-4 padding-top-30" style="text-align:left">
                        &nbsp;
                        <button class="btn btn-success" onclick="LaporanMonitoringMingguanSearch()"><i class="fa fa-search"></i> Search</button>
                        &nbsp;
                        <button class="btn btn-success" onclick="DownloadLaporanMonitoringMingguan()"><i class="fa fa-download"></i> Download</button>
                    </div>

                </div>

                <div class="row padding-15 padding-right-15">
                    <div class="col-lg-12 col-md-12 col-sm-12 col-xs-12">
                        <table id="tblListLaporanMonitoringMingguan" class="display" style="width:100%">
                            <thead>
                                <tr>
                                    <th style="text-align:center; white-space:nowrap" rowspan="2">No.</th>
                                    <th style="text-align:center; white-space:nowrap" rowspan="2">Nama Program</th>
                                    <th style="text-align:center; white-space:nowrap" rowspan="2">Nama Proyek</th>
                                    <th style="text-align:center; white-space:nowrap" rowspan="2">Unit Kerja</th>
                                    <th style="text-align:center; white-space:nowrap" rowspan="2">Nama Project Manager</th>
                                    <th style="text-align:center; white-space:nowrap" colspan="3">Proyek</th>
                                    <th style="text-align:center; white-space:nowrap" rowspan="2">Kendala Internal/Eksternal</th>
                                    <th style="text-align:center; white-space:nowrap" rowspan="2">Rencana Aksi</th>
                                    <th style="text-align:center; white-space:nowrap" rowspan="2">Nama Program Manager</th>
                                    <th style="text-align:center; white-space:nowrap" rowspan="2">Status Project</th>
                                    <th style="text-align:center; white-space:nowrap" rowspan="2">Next for Approval</th>
                                </tr>
                                <tr>
                                    <th style="text-align:center; white-space:nowrap">Target</th>
                                    <th style="text-align:center; white-space:nowrap">Realisasi</th>
                                    <th style="text-align:center; white-space:nowrap">Pencapaian</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>

            </div>
        </section>
    </div>
</div>

<script>

    $(document).ready(function () {

        $('#tblListLaporanMonitoringMingguan').DataTable({
            "bLengthChange": false,
            searching: true,
            "scrollX": true,
            info: false
        });

        $('.ddlYear').select2({
            placeholder: 'Pilih Tahun',
            selectOnClose: false
        });

        $('.ddlMonth').select2({
            placeholder: 'Pilih Bulan',
            selectOnClose: false
        });

        $('.ddlWeek').select2({
            placeholder: 'Pilih Minggu',
            selectOnClose: false
        });

        $('.ddlIsTransformasi').select2({
            placeholder: 'Pilih Tipe',
            selectOnClose: false
        });

        $('.ddlUnitkerja').select2({
            placeholder: 'Pilih Unit Kerja',
            selectOnClose: false
        });

        $('.ddlPMO').select2({
            placeholder: 'Pilih PMO',
            selectOnClose: false
        });

        $('.ddlOwner').select2({
            placeholder: 'Pilih Owner',
            selectOnClose: false
        });

        $('.ddlSponsor').select2({
            placeholder: 'Pilih Sponsor',
            selectOnClose: false
        });

        //GetDDLUnitKerja();
        //GetDDLPMO();
        //GetDDLOwner();
        //GetDDLSponsor();

    });

    function LaporanMonitoringMingguanSearch() {

        data = {
            Year: $('#ddlYear').val(),
            Month: $('#ddlMonth').val(),
            Week: $('#ddlWeek').val(),
            IsTransformasi: $('#ddlIsTransformasi').val(),
            DepartmentCode: $('#ddlUnitkerja').val(),
            NamaProgramManager: $('#ddlPMO').val(),
            NamaProjectOwner: $('#ddlOwner').val(),
            NamaProjectSponsor: $('#ddlSponsor').val()
        }

        $.ajax({
            url: '@Url.Action("LaporanMingguanSearch", "Laporan")',
            data: data,
            success: function (result) {
                debugger;

                if (result.Result === "Success") {

                    $('#tblListLaporanMonitoringMingguan').DataTable().destroy();

                    $('#tblListLaporanMonitoringMingguan').DataTable({
                        "bLengthChange": false,
                        "autoWidth": false,
                        searching: true,
                        "scrollX": true,
                        info: false,
                        data: result.Data,
                        "columns": [
                            {
                                "data": "No",
                                "className": "text-left"
                            },
                            {
                                "data": "ProgramName",
                                "className": "text-left"
                            },
                            {
                                "data": "ProjectName",
                                "className": "text-left"
                            },
                            {
                                "data": "DepartmentCode",
                                "className": "text-left"
                            },
                            {
                                "data": "NamaProjectManager",
                                "className": "text-left"
                            },
                            {
                                "data": "PlanPencapaian",
                                "className": "text-right"
                            },
                            {
                                "data": "RealisasiPencapaian",
                                "className": "text-right"
                            },
                            {
                                "data": "Pencapaian",
                                "className": "text-right"
                            },
                            {
                                "data": "Kendala",
                                "className": "text-left"
                            }, {
                                "data": "RencanaAksi",
                                "className": "text-left"
                            },
                            {
                                "data": "NamaProgramManager",
                                "className": "text-left"
                            },
                            {
                                "data": "StatusProject",
                                "className": "text-left"
                            },
                            {
                                "data": "LastUpdated",
                                "className": "text-left"
                            }
                        ]
                    });

                } else {
                    alert(result.Message);
                }

            },
            error: function (xhr, ajaxOptions, thrownError) {
                debugger;
                alert(xhr.status);
                alert(thrownError);
            }
        });
    }

    function DownloadLaporanMonitoringMingguan() {
        window.open(
            '@Url.Action("ExportExcelLaporanMingguan", "Laporan")'
            + '?Year=' + $('#ddlYear').val()
            + '&Month=' + $('#ddlMonth').val()
            + '&Week=' + $('#ddlWeek').val()
            + '&IsTransformasi=' + $('#ddlIsTransformasi').val()
            + '&DepartmentCode=' + $('#ddlUnitkerja').val()
            + '&NamaProgramManager=' + $('#ddlPMO').val()
            + '&NamaProjectOwner=' + $('#ddlOwner').val()
            + '&NamaProjectSponsor=' + $('#ddlSponsor').val());
    }

    function OnOnchangeDdlYear(CurrentYear, CurrentMonth) {

        var ListMonth = @Html.Raw(Json.Encode(GlobalHelper.ListDropDowMonth()));

        debugger;

        var Year = $('#ddlYear').val();
        var select = document.getElementById("ddlMonth");

        select.innerHTML = "";

        if (Year == CurrentYear) {
            for (var i = 0; i < 12; i++) {
                if (ListMonth[i].Month == CurrentMonth) {
                    select.innerHTML += "<option value=\"" + ListMonth[i].Month + "\">" + ListMonth[i].Description + "</option>";
                    i = 12;
                }
                else {
                    select.innerHTML += "<option value=\"" + ListMonth[i].Month + "\">" + ListMonth[i].Description + "</option>";
                }
            }
        } else {
            for (var i = 0; i < 12; i++) {
                select.innerHTML += "<option value=\"" + ListMonth[i].Month + "\">" + ListMonth[i].Description + "</option>";
            }
        }

        OnOnchangeDdlMonth();

    }
</script>

<script>
    @*function OnOnchangeDdlMonth() {
        var data = {
            Year: $('#ddlYear').val(),
            Month: $('#ddlMonth').val()
        }

        $.ajax({
            type: "GET",
            url: '@Url.Action("GetDdlWeek", "Beranda")',
            data: data,
            traditional: true,
            success: function (result) {
                var select = document.getElementById("ddlWeek");

                // Optional: Clear all existing options first:
                select.innerHTML = "";
                // Populate list with options:
                for (var i = 1; i <= result.JumlahWeek; i++) {
                    var opt = i;
                    select.innerHTML += "<option value=\"" + opt + "\">Minggu Ke-" + opt + "</option>";
                }
            }
        });
    }*@
    function OnOnchangeDdlMonth() {
        var data = {
            Year: $('#ddlYear').val(),
            Month: $('#ddlMonth').val()
        }
        var da = new Date();
        var Cyear = da.getFullYear();
        var Cmonth = da.getMonth() + 1;
        $.ajax({
            type: "GET",
            url: '@Url.Action("GetDdlWeek", "Beranda")',
            data: data,
            traditional: true,
            success: function (result) {
                var select = document.getElementById("ddlWeek");

                // Optional: Clear all existing options first:
                select.innerHTML = "";
                // Populate list with options:
                if (result.Month < Cmonth || result.Year < Cyear) {
                    for (var i = 1; i <= result.JumlahWeek; i++) {
                        var opt = i;
                        select.innerHTML += "<option value=\"" + opt + "\">Minggu Ke-" + opt + "</option>";
                    }
                }
                else {
                    for (var i = 1; i <= result.Week; i++) {
                        var opt = i;
                        select.innerHTML += "<option value=\"" + opt + "\">Minggu Ke-" + opt + "</option>";
                    }
                }
            }
        });
    }
    function GetDDLPMO() {
        data = {
            Year: $('#ddlYear').val(),
            Month: $('#ddlMonth').val(),
            Week: $('#ddlWeek').val()
        }
        console.log(data);
        $.ajax({
            type: "GET",
            url: '@Url.Action("DropdownlistPMO", "Laporan")',
            data: data,
            traditional: true,
            success: function (result) {
                var select = document.getElementById("ddlPMO");
                debugger;
                // Optional: Clear all existing options first:
                select.innerHTML = "";

                select.innerHTML += "<option value=0>All</option>";

                // Populate list with options:
                if (result.Data.length > 0) {
                    for (var i = 0; i < result.Data.length; i++) {
                        select.innerHTML += "<option value=\"" + result.Data[i].Username + "\">" + result.Data[i].Nama + "</option>";
                    }
                }

            }
        });
    }
    
    function GetDDLOwner() {
        data = {
            Year: $('#ddlYear').val(),
            Month: $('#ddlMonth').val(),
            Week: $('#ddlWeek').val()
        }

        $.ajax({
            type: "GET",
            url: '@Url.Action("DropdownlistOwner", "Laporan")',
            data: data,
            traditional: true,
            success: function (result) {
                var select = document.getElementById("ddlOwner");
                debugger;
                // Optional: Clear all existing options first:
                select.innerHTML = "";

                select.innerHTML += "<option value=0>All</option>";

                // Populate list with options:
                if (result.Data.length > 0) {
                    for (var i = 0; i < result.Data.length; i++) {
                        select.innerHTML += "<option value=\"" + result.Data[i].Username + "\">" + result.Data[i].Nama + "</option>";
                    }
                }

            }
        });
    }

    function GetDDLSponsor() {
        data = {
            Year: $('#ddlYear').val(),
            Month: $('#ddlMonth').val(),
            Week: $('#ddlWeek').val()
        }

        $.ajax({
            type: "GET",
            url: '@Url.Action("DropdownlistSponsor", "Laporan")',
            data: data,
            traditional: true,
            success: function (result) {
                var select = document.getElementById("ddlSponsor");
                debugger;
                // Optional: Clear all existing options first:
                select.innerHTML = "";

                select.innerHTML += "<option value=0>All</option>";

                // Populate list with options:
                if (result.Data.length > 0) {
                    for (var i = 0; i < result.Data.length; i++) {
                        select.innerHTML += "<option value=\"" + result.Data[i].Username + "\">" + result.Data[i].Nama + "</option>";
                    }
                }

            }
        });
    }

    function GetDDLUnitKerja() {
        var data = {
            IDDirektorat: 0
        }

        $.ajax({
            type: "GET",
            url: '@Url.Action("LaporanDetailAnggaranHeader", "Laporan")',
            data: data,
            traditional: true,
            success: function (result) {
                var select = document.getElementById("ddlUnitkerja");
                debugger;
                // Optional: Clear all existing options first:
                select.innerHTML = "";

                select.innerHTML += "<option value=0>All</option>";

                // Populate list with options:
                if (result.Data.length > 0) {
                    for (var i = 0; i < result.Data.length; i++) {
                        select.innerHTML += "<option value=\"" + result.Data[i].IDDepartment + "\">" + result.Data[i].DepartmentCode + "</option>";
                    }
                }

            }
        });
    }

</script>
